<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBAC POS System - Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            display: grid;
            grid-template-areas:
                "header header"
                "sidebar main";
            grid-template-columns: 250px 1fr;
            grid-template-rows: 60px 1fr;
            min-height: 100vh;
        }

        .header {
            grid-area: header;
            background: white;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            color: #667eea;
        }

        .logo i {
            font-size: 20px;
        }

        .tenant-info {
            color: #666;
            font-size: 14px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            text-align: right;
        }

        .user-roles {
            margin-top: 5px;
        }

        .role-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .sidebar {
            grid-area: sidebar;
            background: #2c3e50;
            padding: 20px 0;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #34495e;
            color: white;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .main-content {
            grid-area: main;
            padding: 20px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: #2c3e50;
            font-size: 28px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .stat-card:nth-child(1) .stat-icon { background: #667eea; }
        .stat-card:nth-child(2) .stat-icon { background: #28a745; }
        .stat-card:nth-child(3) .stat-icon { background: #ffc107; }
        .stat-card:nth-child(4) .stat-icon { background: #dc3545; }

        .stat-content h3 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .stat-content p {
            color: #666;
            font-size: 14px;
        }

        .item-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #e1e1e1;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-info { background: #17a2b8; color: white; }

        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .data-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        tr.selected {
            background: #e3f2fd;
        }

        .transaction-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .transaction-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1e1e1;
        }

        .transaction-items {
            margin-bottom: 20px;
        }

        .transaction-items table {
            margin-bottom: 20px;
        }

        .add-item-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .transaction-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #e1e1e1;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .summary-row.total {
            font-weight: bold;
            font-size: 18px;
            border-top: 1px solid #ccc;
            padding-top: 10px;
            margin-top: 10px;
        }

        .report-filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }

        .message {
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease;
        }

        .message.error {
            background: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .create-only,
        .update-only,
        .delete-only,
        .admin-only {
            display: none;
        }

        @media (max-width: 768px) {
            body {
                grid-template-areas:
                    "header"
                    "main";
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr;
            }

            .sidebar {
                display: none;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .transaction-header {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <span>RBAC POS</span>
            </div>
            <div class="tenant-info">
                <span id="tenantName">Loading...</span>
            </div>
        </div>
        
        <div class="header-right">
            <div class="user-info">
                <span id="userName">Loading...</span>
                <div class="user-roles" id="userRoles">
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
        <nav class="nav-menu">
            <div class="nav-item active" data-page="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-page="items">
                <i class="fas fa-boxes"></i>
                <span>Item Management</span>
            </div>
            <div class="nav-item" data-page="transactions">
                <i class="fas fa-receipt"></i>
                <span>Create Transaction</span>
            </div>
            <div class="nav-item" data-page="transaction-history">
                <i class="fas fa-history"></i>
                <span>Transaction History</span>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <div class="page-header">
                <h1>Dashboard</h1>
                <p>Welcome to your RBAC POS system, <span id="welcomeUser">User</span>!</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalItems">0</h3>
                        <p>Total Items</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalTransactions">0</h3>
                        <p>Total Transactions</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalRevenue">$0.00</h3>
                        <p>Total Revenue</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="activeUsers">4</h3>
                        <p>Active Users</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item Management Page -->
        <div id="items" class="page">
            <div class="page-header">
                <h1>Item Management</h1>
                <p>Manage your inventory items</p>
            </div>
            
            <div class="item-form">
                <h3>Item Information</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="itemName">Item Name</label>
                        <input type="text" id="itemName" placeholder="Enter item name">
                    </div>
                    <div class="form-group">
                        <label for="itemQuantity">Quantity</label>
                        <input type="number" id="itemQuantity" min="0" placeholder="Enter quantity">
                    </div>
                    <div class="form-group">
                        <label for="itemPrice">Price</label>
                        <input type="number" id="itemPrice" min="0" step="0.01" placeholder="Enter price">
                    </div>
                    <div class="form-group">
                        <label for="itemCategory">Category</label>
                        <select id="itemCategory">
                            <option value="">Select Category</option>
                            <option value="Grocery">Grocery</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Stationery">Stationery</option>
                            <option value="Pharmacy">Pharmacy</option>
                        </select>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success create-only" id="btnCreate" onclick="createItem()">
                        <i class="fas fa-plus"></i> Create
                    </button>
                    <button class="btn btn-primary" id="btnRead" onclick="loadItems()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button class="btn btn-warning update-only" id="btnUpdate" onclick="updateItem()">
                        <i class="fas fa-edit"></i> Update
                    </button>
                    <button class="btn btn-danger delete-only" id="btnDelete" onclick="deleteItem()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <button class="btn btn-secondary" onclick="clearItemForm()">
                        <i class="fas fa-eraser"></i> Clear
                    </button>
                </div>
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <!-- Items will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Create Transaction Page -->
        <div id="transactions" class="page">
            <div class="page-header">
                <h1>Create Transaction</h1>
                <p>Process new sales transactions</p>
            </div>
            
            <div class="transaction-form">
                <div class="transaction-header">
                    <div class="form-group">
                        <label for="transactionDate">Transaction Date</label>
                        <input type="date" id="transactionDate">
                    </div>
                    <div class="form-group">
                        <label for="transactionUsername">Username</label>
                        <input type="text" id="transactionUsername" readonly>
                    </div>
                </div>
                
                <div class="transaction-items">
                    <h4>Transaction Items</h4>
                    <button class="add-item-btn" onclick="addTransactionRow()">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                    
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="transactionItemsBody">
                                <!-- Transaction items will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="transaction-summary">
                    <div class="summary-row">
                        <span>Total Amount:</span>
                        <span id="transactionTotal">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Discount ($):</span>
                        <input type="number" id="discountAmount" min="0" step="0.01" value="0" onchange="calculateTransactionTotal()">
                    </div>
                    <div class="summary-row total">
                        <span>Net Amount:</span>
                        <span id="transactionNetAmount">$0.00</span>
                    </div>
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveTransaction()">
                            <i class="fas fa-save"></i> Save Transaction
                        </button>
                        <button class="btn btn-info" id="generateInvoiceBtn" onclick="generateInvoice()" style="display: none;">
                            <i class="fas fa-file-invoice"></i> Generate Invoice
                        </button>
                        <button class="btn btn-secondary" onclick="clearTransactionForm()">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History Page -->
        <div id="transaction-history" class="page">
            <div class="page-header">
                <h1>Transaction History</h1>
                <p>View all completed transactions and generate reports</p>
            </div>
            
            <!-- Report Generation Section -->
            <div class="report-filters">
                <h3>Generate Report</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label for="reportStartDate">Start Date</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label for="reportEndDate">End Date</label>
                        <input type="date" id="reportEndDate">
                    </div>
                    <div class="form-group">
                        <label for="reportUsername">Username Filter</label>
                        <input type="text" id="reportUsername" placeholder="Enter username (optional)">
                    </div>
                    <div class="form-group">
                        <label for="reportType">Report Type</label>
                        <select id="reportType">
                            <option value="summary">Summary Report</option>
                            <option value="detailed">Detailed Report</option>
                        </select>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-info" onclick="generateReport()">
                        <i class="fas fa-file-pdf"></i> Generate PDF Report
                    </button>
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                </div>
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>Username</th>
                            <th>Total Amount</th>
                            <th>Discount</th>
                            <th>Net Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionHistoryBody">
                        <!-- Transaction history will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="message-container"></div>

    <script>
        // Global variables
        let currentUser = null
        let items = []
        let transactions = []
        let selectedItemId = null
        let transactionRowCounter = 0

        // Initialize dashboard
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                // Get current user from backend
                const response = await fetch('/api/user', {
                    credentials: 'include'
                })
                if (!response.ok) {
                    window.location.href = '/'
                    return
                }
                
                currentUser = await response.json()
                
                // Rest of your initialization code...
                setupUserInterface()
                setupNavigation()
                setupPermissions()
                await loadDashboardData()
                await loadItems()
                await loadTransactionHistory()
                
                // Set current date
                document.getElementById("transactionDate").value = new Date().toISOString().split('T')[0]
                document.getElementById("transactionUsername").value = currentUser.username
            } catch (error) {
                console.error("Error initializing dashboard:", error)
                window.location.href = '/'
            }
        })

        function setupUserInterface() {
            document.getElementById("userName").textContent = currentUser.username
            document.getElementById("welcomeUser").textContent = currentUser.username
            document.getElementById("tenantName").textContent = currentUser.tenantName

            const rolesContainer = document.getElementById("userRoles")
            rolesContainer.innerHTML = ""
            currentUser.roles.forEach((role) => {
                const badge = document.createElement("span")
                badge.className = "role-badge"
                badge.textContent = role
                rolesContainer.appendChild(badge)
            })
        }

        function setupNavigation() {
            const navItems = document.querySelectorAll(".nav-item")
            navItems.forEach((item) => {
                item.addEventListener("click", function (e) {
                    e.preventDefault()
                    const page = this.dataset.page
                    showPage(page)

                    navItems.forEach((nav) => nav.classList.remove("active"))
                    this.classList.add("active")
                })
            })
        }

        function showPage(pageId) {
            const pages = document.querySelectorAll(".page")
            pages.forEach((page) => page.classList.remove("active"))

            const targetPage = document.getElementById(pageId)
            if (targetPage) {
                targetPage.classList.add("active")
            }
        }

        function setupPermissions() {
            const permissions = currentUser.permissions

            // Show/hide elements based on permissions
            if (permissions.includes("Create_Item")) {
                document.querySelectorAll(".create-only").forEach((el) => (el.style.display = "inline-flex"))
            }

            if (permissions.includes("Update_Item")) {
                document.querySelectorAll(".update-only").forEach((el) => (el.style.display = "inline-flex"))
            }

            if (permissions.includes("Delete_Item")) {
                document.querySelectorAll(".delete-only").forEach((el) => (el.style.display = "inline-flex"))
            }

            // Admin-only features
            if (currentUser.roles.includes("Admin")) {
                document.querySelectorAll(".admin-only").forEach((el) => (el.style.display = "block"))
            }
        }

        async function loadDashboardData() {
            try {
                // Load items and transactions for dashboard stats
                await loadItems()
                await loadTransactionHistory()
                
                document.getElementById("totalItems").textContent = items.length
                document.getElementById("totalTransactions").textContent = transactions.length

                const totalRevenue = transactions.reduce((sum, t) => sum + (t.NetAmount || 0), 0)
                document.getElementById("totalRevenue").textContent = `$${totalRevenue.toFixed(2)}`
            } catch (error) {
                console.error("Error loading dashboard data:", error)
            }
        }

        // Item Management Functions
        async function loadItems() {
            try {
                const response = await fetch('/api/items', {
                    credentials: 'include'
                })
                
                if (response.status === 401) {
                    window.location.href = '/'
                    return
                }
                
                if (response.ok) {
                    items = await response.json()
                    displayItems()
                } else {
                    const errorData = await response.json()
                    showMessage(errorData.error || "Error loading items", "error")
                }
            } catch (error) {
                console.error("Error loading items:", error)
                showMessage("Network error: Could not connect to server", "error")
            }
        }

        function displayItems() {
            const tbody = document.getElementById("itemsTableBody")
            tbody.innerHTML = ""

            items.forEach((item) => {
                const row = document.createElement("tr")
                row.onclick = () => selectItem(item)
                row.innerHTML = `
                    <td>${item.ItemID}</td>
                    <td>${item.ItemName}</td>
                    <td>${item.Quantity}</td>
                    <td>$${item.Price.toFixed(2)}</td>
                    <td>${item.Category}</td>
                `
                tbody.appendChild(row)
            })
        }

        function selectItem(item) {
            selectedItemId = item.ItemID
            document.getElementById("itemName").value = item.ItemName
            document.getElementById("itemQuantity").value = item.Quantity
            document.getElementById("itemPrice").value = item.Price
            document.getElementById("itemCategory").value = item.Category

            // Highlight selected row
            document.querySelectorAll("#itemsTableBody tr").forEach(row => row.classList.remove("selected"))
            event.currentTarget.classList.add("selected")
        }

        async function createItem() {
            if (!currentUser.permissions.includes("Create_Item")) {
                showMessage("Access denied: You do not have permission to create items", "error")
                return
            }

            const name = document.getElementById("itemName").value.trim()
            const quantity = parseInt(document.getElementById("itemQuantity").value)
            const price = parseFloat(document.getElementById("itemPrice").value)
            const category = document.getElementById("itemCategory").value

            if (!name || isNaN(quantity) || isNaN(price) || !category) {
                showMessage("Please fill in all fields with valid values", "error")
                return
            }

            if (confirm("Are you sure you want to create this item?")) {
                try {
                    const response = await fetch('/api/items', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            itemName: name,
                            quantity: quantity,
                            price: price,
                            category: category
                        })
                    })

                    if (response.ok) {
                        await loadItems()
                        clearItemForm()
                        await loadDashboardData()
                        showMessage("Item created successfully!")
                    } else {
                        const error = await response.json()
                        showMessage(error.error || "Error creating item", "error")
                    }
                } catch (error) {
                    console.error("Error creating item:", error)
                    showMessage("Error creating item", "error")
                }
            }
        }

        async function updateItem() {
            if (!currentUser.permissions.includes("Update_Item")) {
                showMessage("Access denied: You do not have permission to update items", "error")
                return
            }

            if (!selectedItemId) {
                showMessage("Please select an item to update", "error")
                return
            }

            const name = document.getElementById("itemName").value.trim()
            const quantity = parseInt(document.getElementById("itemQuantity").value)
            const price = parseFloat(document.getElementById("itemPrice").value)
            const category = document.getElementById("itemCategory").value

            if (!name || isNaN(quantity) || isNaN(price) || !category) {
                showMessage("Please fill in all fields with valid values", "error")
                return
            }

            if (confirm("Are you sure you want to update this item?")) {
                try {
                    const response = await fetch(`/api/items/${selectedItemId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            itemName: name,
                            quantity: quantity,
                            price: price,
                            category: category
                        })
                    })

                    if (response.ok) {
                        await loadItems()
                        clearItemForm()
                        showMessage("Item updated successfully!")
                    } else {
                        const error = await response.json()
                        showMessage(error.error || "Error updating item", "error")
                    }
                } catch (error) {
                    console.error("Error updating item:", error)
                    showMessage("Error updating item", "error")
                }
            }
        }

        async function deleteItem() {
            if (!currentUser.permissions.includes("Delete_Item")) {
                showMessage("Access denied: You do not have permission to delete items", "error")
                return
            }

            if (!selectedItemId) {
                showMessage("Please select an item to delete", "error")
                return
            }

            if (confirm("Are you sure you want to delete this item?")) {
                try {
                    const response = await fetch(`/api/items/${selectedItemId}`, {
                        method: 'DELETE'
                    })

                    if (response.ok) {
                        await loadItems()
                        clearItemForm()
                        await loadDashboardData()
                        showMessage("Item deleted successfully!")
                    } else {
                        const error = await response.json()
                        showMessage(error.error || "Error deleting item", "error")
                    }
                } catch (error) {
                    console.error("Error deleting item:", error)
                    showMessage("Error deleting item", "error")
                }
            }
        }

        function clearItemForm() {
            selectedItemId = null
            document.getElementById("itemName").value = ""
            document.getElementById("itemQuantity").value = ""
            document.getElementById("itemPrice").value = ""
            document.getElementById("itemCategory").value = ""
            
            document.querySelectorAll("#itemsTableBody tr").forEach(row => row.classList.remove("selected"))
        }

        // Transaction Functions
        function addTransactionRow() {
            const tbody = document.getElementById("transactionItemsBody")
            const row = document.createElement("tr")
            const rowId = ++transactionRowCounter

            row.innerHTML = `
                <td>
                    <select onchange="updateItemPrice(this, ${rowId})">
                        <option value="">Select Item</option>
                        ${items.map(item => `<option value="${item.ItemName}" data-price="${item.Price}">${item.ItemName}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" min="1" value="1" onchange="calculateRowAmount(${rowId})">
                </td>
                <td>
                    <input type="number" step="0.01" min="0" readonly>
                </td>
                <td class="amount">$0.00</td>
                <td>
                    <button class="btn btn-danger" onclick="removeTransactionRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `
            row.dataset.rowId = rowId
            tbody.appendChild(row)
        }

        function updateItemPrice(selectElement, rowId) {
            const selectedOption = selectElement.options[selectElement.selectedIndex]
            const price = selectedOption.dataset.price || 0
            const row = selectElement.closest('tr')
            const priceInput = row.querySelector('td:nth-child(3) input')
            
            priceInput.value = price
            calculateRowAmount(rowId)
        }

        function calculateRowAmount(rowId) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`)
            const quantity = parseFloat(row.querySelector('td:nth-child(2) input').value) || 0
            const price = parseFloat(row.querySelector('td:nth-child(3) input').value) || 0
            const amount = quantity * price
            
            row.querySelector('.amount').textContent = `$${amount.toFixed(2)}`
            calculateTransactionTotal()
        }

        function removeTransactionRow(button) {
            button.closest('tr').remove()
            calculateTransactionTotal()
        }

        function calculateTransactionTotal() {
            const rows = document.querySelectorAll('#transactionItemsBody tr')
            let total = 0

            rows.forEach(row => {
                const amountText = row.querySelector('.amount').textContent
                const amount = parseFloat(amountText.replace('$', '')) || 0
                total += amount
            })

            document.getElementById('transactionTotal').textContent = `$${total.toFixed(2)}`

            const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0
            const netAmount = total - discountAmount

            document.getElementById('transactionNetAmount').textContent = `$${netAmount.toFixed(2)}`
        }

        async function saveTransaction() {
    const rows = document.querySelectorAll('#transactionItemsBody tr')
    if (rows.length === 0) {
        showMessage("Please add at least one item to the transaction", "error")
        return
    }

    const transactionItems = []
    let isValid = true

    rows.forEach(row => {
        const itemSelect = row.querySelector('td:nth-child(1) select')
        const quantityInput = row.querySelector('td:nth-child(2) input')
        const priceInput = row.querySelector('td:nth-child(3) input')
        
        if (!itemSelect.value || !quantityInput.value || !priceInput.value) {
            isValid = false
            return
        }

        transactionItems.push({
            itemName: itemSelect.value,
            quantity: parseInt(quantityInput.value),
            price: parseFloat(priceInput.value),
            amount: parseInt(quantityInput.value) * parseFloat(priceInput.value)
        })
    })

    if (!isValid) {
        showMessage("Please fill in all item details", "error")
        return
    }

    const totalAmount = parseFloat(document.getElementById('transactionTotal').textContent.replace('$', ''))
    const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0
    const netAmount = parseFloat(document.getElementById('transactionNetAmount').textContent.replace('$', ''))

    const transactionData = {
        transactionDate: document.getElementById('transactionDate').value,
        totalAmount: totalAmount,
        discount: discountAmount,
        netAmount: netAmount,
        items: transactionItems
    }

    try {
        const response = await fetch('/api/transactions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(transactionData)
        })

        if (response.ok) {
            const result = await response.json()
            window.lastTransactionId = result.transactionID // Store for invoice generation
            
            await loadDashboardData()
            await loadItems()
            await loadTransactionHistory()
            
            // Show invoice generation button
            document.getElementById('generateInvoiceBtn').style.display = 'inline-flex'
            
            showMessage("Transaction saved successfully! You can now generate an invoice.")
        } else {
            const error = await response.json()
            showMessage(error.error || "Error saving transaction", "error")
        }
    } catch (error) {
        console.error("Error saving transaction:", error)
        showMessage("Error saving transaction", "error")
    }
}

        function clearTransactionForm() {
    document.getElementById('transactionItemsBody').innerHTML = ""
    document.getElementById('discountAmount').value = "0"
    document.getElementById('transactionTotal').textContent = "$0.00"
    document.getElementById('transactionNetAmount').textContent = "$0.00"
    document.getElementById('generateInvoiceBtn').style.display = 'none'
    window.lastTransactionId = null
    transactionRowCounter = 0
}

        // Transaction History and Report Functions
        async function loadTransactionHistory() {
            try {
                // Get filter values
                const startDate = document.getElementById('reportStartDate')?.value || ''
                const endDate = document.getElementById('reportEndDate')?.value || ''
                const username = document.getElementById('reportUsername')?.value || ''
                
                // Build query parameters
                const params = new URLSearchParams()
                if (startDate) params.append('start_date', startDate)
                if (endDate) params.append('end_date', endDate)
                if (username) params.append('username', username)
                
                const response = await fetch(`/api/transactions?${params.toString()}`, {
                    credentials: 'include'
                })
                
                if (response.status === 401) {
                    window.location.href = '/'
                    return
                }
                
                if (response.ok) {
                    transactions = await response.json()
                    displayTransactionHistory()
                } else {
                    const errorData = await response.json()
                    showMessage(errorData.error || "Error loading transaction history", "error")
                }
            } catch (error) {
                console.error("Error loading transaction history:", error)
                showMessage("Network error: Could not connect to server", "error")
            }
        }

        function displayTransactionHistory() {
    const tbody = document.getElementById("transactionHistoryBody")
    tbody.innerHTML = ""

    transactions.forEach((transaction) => {
        const row = document.createElement("tr")
        row.innerHTML = `
            <td>${transaction.TransactionID}</td>
            <td>${new Date(transaction.TransactionDate).toLocaleDateString()}</td>
            <td>${transaction.Username}</td>
            <td>$${transaction.TotalAmount.toFixed(2)}</td>
            <td>$${transaction.Discount.toFixed(2)}</td>
            <td>$${transaction.NetAmount.toFixed(2)}</td>
            <td>
                <button class="btn btn-primary" onclick="viewTransactionDetails(${transaction.TransactionID})" style="margin-right: 5px;">
                    <i class="fas fa-eye"></i> View
                </button>
                <button class="btn btn-info" onclick="generateInvoice(${transaction.TransactionID})">
                    <i class="fas fa-file-invoice"></i> Invoice
                </button>
            </td>
        `
        tbody.appendChild(row)
    })
}

        function viewTransactionDetails(transactionID) {
            const transaction = transactions.find(t => t.TransactionID === transactionID)
            if (transaction) {
                alert(`Transaction #${transaction.TransactionID}\n\nDate: ${new Date(transaction.TransactionDate).toLocaleString()}\nUser: ${transaction.Username}\nTotal: $${transaction.TotalAmount.toFixed(2)}\nDiscount: $${transaction.Discount.toFixed(2)}\nNet Amount: $${transaction.NetAmount.toFixed(2)}`)
            }
        }

        // Report Generation Functions
        async function generateReport() {
            try {
                const startDate = document.getElementById('reportStartDate').value
                const endDate = document.getElementById('reportEndDate').value
                const username = document.getElementById('reportUsername').value
                const reportType = document.getElementById('reportType').value

                const reportData = {
                    start_date: startDate,
                    end_date: endDate,
                    username: username,
                    report_type: reportType
                }

                showMessage("Generating report... Please wait", "info")

                const response = await fetch('/api/generate-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(reportData),
                    credentials: 'include'
                })

                if (response.ok) {
                    // Create a blob from the response
                    const blob = await response.blob()
                    
                    // Create a download link
                    const url = window.URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.style.display = 'none'
                    a.href = url
                    a.download = `transaction_report_${new Date().toISOString().split('T')[0]}.pdf`
                    
                    // Trigger download
                    document.body.appendChild(a)
                    a.click()
                    window.URL.revokeObjectURL(url)
                    document.body.removeChild(a)
                    
                    showMessage("Report generated and downloaded successfully!")
                } else {
                    const error = await response.json()
                    showMessage(error.error || "Error generating report", "error")
                }
            } catch (error) {
                console.error("Error generating report:", error)
                showMessage("Error generating report", "error")
            }
        }

        function applyFilters() {
            loadTransactionHistory()
        }

        function clearFilters() {
            document.getElementById('reportStartDate').value = ''
            document.getElementById('reportEndDate').value = ''
            document.getElementById('reportUsername').value = ''
            document.getElementById('reportType').value = 'summary'
            loadTransactionHistory()
        }

        function showMessage(message, type = "success") {
            const messageContainer = document.getElementById("messageContainer")
            const messageDiv = document.createElement("div")
            messageDiv.className = `message ${type}`
            messageDiv.textContent = message

            messageContainer.appendChild(messageDiv)

            setTimeout(() => {
                messageDiv.remove()
            }, 3000)
        }

        function logout() {
            window.location.href = '/logout'
        }

        // Invoice Generation Functions
async function generateInvoice(transactionId = null) {
    try {
        const id = transactionId || window.lastTransactionId
        
        if (!id) {
            showMessage("No transaction selected for invoice generation", "error")
            return
        }

        showMessage("Generating invoice... Please wait", "info")

        const response = await fetch(`/api/generate-invoice/${id}`, {
            credentials: 'include'
        })

        if (response.ok) {
            // Create a blob from the response
            const blob = await response.blob()
            
            // Create a download link
            const url = window.URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.style.display = 'none'
            a.href = url
            a.download = `invoice_${String(id).padStart(6, '0')}.pdf`
            
            // Trigger download
            document.body.appendChild(a)
            a.click()
            window.URL.revokeObjectURL(url)
            document.body.removeChild(a)
            
            showMessage("Invoice generated and downloaded successfully!")
        } else {
            const error = await response.json()
            showMessage(error.error || "Error generating invoice", "error")
        }
    } catch (error) {
        console.error("Error generating invoice:", error)
        showMessage("Error generating invoice", "error")
    }
}
    </script>
</body>
</html>
